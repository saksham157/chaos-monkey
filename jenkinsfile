stage('Deploy EC2') {
   steps {
       withCredentials([string(credentialsId: 'AWS_ACCESS_KEY', variable: 'AWS_ACCESS_KEY_ID'),
                        string(credentialsId: 'AWS_SECRET_KEY', variable: 'AWS_SECRET_ACCESS_KEY')]) {

           sh '''
           cd $WORKSPACE
           aws cloudformation deploy \
           --template-file chaos-monkey.json \
           --stack-name chaos-lab-stack
           '''
       }
   }
}

pipeline {
    agent any

    stages {

        stage('Git Pull') {
            steps {
                checkout scm
            }
        }

        stage('Start Payment') {
            steps {
                sh '''
                cd payment
                npm install
                node server.js &
                '''
            }
        }

        stage('Start Order') {
            steps {
                sh '''
                cd order
                npm install
                node order_service.js  &
                '''
            }
        }

        stage('Chaos Test') {
            steps {
                sh '''
                cd chaos
                node monkey.js &
                bash ../recovery/heal.sh &
                '''
            }
        }

    }
}
