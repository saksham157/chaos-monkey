pipeline {
    agent any

    stages {

        stage('Install AWS CLI if missing') {
            steps {
                sh '''
                if ! command -v aws
                then
                    echo "Installing AWS CLI v2"

                    cd /tmp
                    curl https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip -o awscliv2.zip

                    apt install -y unzip
                    unzip -o awscliv2.zip

                    sudo ./aws/install --update
                fi

                aws --version
                '''
            }
        }

        stage('Create EC2') {
            steps {

                withCredentials([
                    string(credentialsId: 'AWS_ACCESS_KEY', variable: 'AWS_ACCESS_KEY'),
                    string(credentialsId: 'AWS_SECRET_KEY', variable: 'AWS_SECRET_KEY')
                ]) {

                    sh '''
                    export AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY
                    export AWS_SECRET_ACCESS_KEY=$AWS_SECRET_KEY

                    cd $WORKSPACE

                    aws cloudformation deploy \
                    --template-file infra.json \
                    --stack-name chaos-lab-stack
                    '''
                }

            }
        }

    }
}
