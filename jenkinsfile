pipeline {
    agent any

    options {
        timestamps()
    }

    stages {

        stage('Checkout Code') {
            steps {
                checkout scm
            }
        }

        stage('Verify / Install AWS CLI') {
            steps {
                sh '''
                if ! command -v aws >/dev/null 2>&1; then
                    echo "AWS CLI not found. Installing AWS CLI v2..."

                    cd /tmp
                    curl -s https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip -o awscliv2.zip
                    sudo apt-get update -y
                    sudo apt-get install -y unzip
                    unzip -o awscliv2.zip
                    sudo ./aws/install --update
                fi

                aws --version
                '''
            }
        }

        stage('Validate CloudFormation Template') {
            steps {
                withAWS(credentials: 'aws-creds', region: 'us-east-1') {
                    sh '''
                    aws cloudformation validate-template \
                      --template-body file://infra.json
                    '''
                }
            }
        }

        stage('Create / Update EC2 Stack') {
            steps {
                withAWS(credentials: 'aws-creds', region: 'us-east-1') {
                    sh '''
                    aws cloudformation deploy \
                      --template-file infra.json \
                      --stack-name chaos-lab-stack \
                      --capabilities CAPABILITY_NAMED_IAM
                    '''
                }
            }
        }
    }

    post {
        success {
            echo "CloudFormation stack deployed successfully."
        }
        failure {
            echo "Deployment failed. Fetching stack events for debugging..."
            withAWS(credentials: 'aws-creds', region: 'us-east-1') {
                sh '''
                aws cloudformation describe-stack-events \
                  --stack-name chaos-lab-stack \
                  --max-items 20 || true
                '''
            }
        }
    }
}
